# 修复产品编号生成和表单值设置问题

## 问题分析

### 当前情况

- **错误现象**：
  - 新增产品时，产品编号输入框为空，没有自动生成
  - 编辑产品时，产品编号输入框为空，没有显示当前产品的编号
  - 点击"重新生成"按钮也没有反应

- **预期行为**：
  - 新增产品时，自动生成产品编号并填充到输入框中
  - 编辑产品时，显示当前产品的编号
  - 点击"重新生成"按钮可以重新生成产品编号

### 根本原因

1. **useEffect依赖问题**：
   - useEffect的依赖数组中没有包含generateAndFillCode函数
   - 这可能导致useEffect使用旧的函数引用，无法正确生成产品编号

2. **generateAndFillCode函数调用问题**：
   - 函数可能没有被正确调用
   - 或者调用后没有正确设置表单值

3. **表单重置问题**：
   - form.resetFields()可能会清除掉刚刚生成的产品编号
   - 新增模式下，resetFields()和generateAndFillCode()的调用顺序可能有问题

4. **后端API问题**：
   - 后端的generate-code API可能没有正确返回产品编号
   - 或者返回的格式不符合预期

5. **表单初始值问题**：
   - initialValues可能没有被正确传递到组件中
   - 或者传递的initialValues中没有包含code字段

## 修复方案

### 1. 修复useEffect依赖

确保useEffect的依赖数组包含所有必要的依赖项：

```typescript
// 监听抽屉可见性变化，更新表单值
React.useEffect(() => {
  if (visible) {
    if (isEditing && initialValues) {
      // 编辑模式：将initialValues设置到表单中
      const formattedInitialValues = {
        ...initialValues,
        status: initialValues.status === 1
      };
      form.setFieldsValue(formattedInitialValues);
    } else {
      // 新增模式：重置表单并生成产品编号
      form.resetFields();
      generateAndFillCode();
    }
  }
}, [visible, isEditing, initialValues, form, generateAndFillCode]);
```

### 2. 修复generateAndFillCode函数

确保generateAndFillCode函数能够正确调用后端API，并将生成的编号填充到表单中：

```typescript
// 生成并填充产品编号
const generateAndFillCode = React.useCallback(async () => {
  try {
    setGeneratingCode(true);
    const code = await productService.generateProductCode();
    form.setFieldValue('code', code);
  } catch (error) {
    console.error('Failed to generate product code:', error);
    // 生成失败时，使用默认值
    form.setFieldValue('code', 'P0001');
  } finally {
    setGeneratingCode(false);
  }
}, [form]);
```

### 3. 修复表单重置问题

确保表单重置不会清除掉刚刚生成的产品编号：

```typescript
// 新增模式：重置表单并生成产品编号
form.resetFields();
// 使用setTimeout确保表单重置完成后再生成编号
setTimeout(() => {
  generateAndFillCode();
}, 0);
```

### 4. 检查后端API

确保后端的generate-code API能够正确返回产品编号：

```go
// generateProductCodeAPI 生成产品编号API
func generateProductCodeAPI(c *gin.Context) {
  code, err := generateProductCode(database.DB)
  if err != nil {
    c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to generate product code"})
    return
  }
  c.JSON(http.StatusOK, gin.H{"code": code})
}
```

### 5. 确保initialValues正确传递

确保initialValues被正确传递到组件中，并且包含code字段：

```typescript
// ProductsPage.tsx
const showEditModal = (product: Product) => {
  setIsEditing(true);
  setCurrentProduct(product);
  setIsDrawerVisible(true);
};

// ProductForm.tsx
<ProductForm
  initialValues={currentProduct}
  onSubmit={isEditing ? handleUpdate : handleCreate}
  onCancel={() => setIsDrawerVisible(false)}
  isEditing={isEditing}
  visible={isDrawerVisible}
/>
```

### 6. 添加调试日志

添加调试日志，方便排查问题：

```typescript
// 生成并填充产品编号
const generateAndFillCode = React.useCallback(async () => {
  try {
    setGeneratingCode(true);
    console.log('Generating product code...');
    const code = await productService.generateProductCode();
    console.log('Generated product code:', code);
    form.setFieldValue('code', code);
    console.log('Set product code to form:', code);
  } catch (error) {
    console.error('Failed to generate product code:', error);
  } finally {
    setGeneratingCode(false);
  }
}, [form]);

// 监听抽屉可见性变化，更新表单值
React.useEffect(() => {
  console.log('Visible changed:', visible);
  console.log('Is editing:', isEditing);
  console.log('Initial values:', initialValues);
  if (visible) {
    if (isEditing && initialValues) {
      // 编辑模式：将initialValues设置到表单中
      const formattedInitialValues = {
        ...initialValues,
        status: initialValues.status === 1
      };
      console.log('Setting form values:', formattedInitialValues);
      form.setFieldsValue(formattedInitialValues);
    } else {
      // 新增模式：重置表单并生成产品编号
      console.log('Resetting form and generating code...');
      form.resetFields();
      generateAndFillCode();
    }
  }
}, [visible, isEditing, initialValues, form, generateAndFillCode]);
```

## 实施步骤

1. **修复useEffect依赖**：
   - 将generateAndFillCode函数添加到useEffect的依赖数组中

2. **修复generateAndFillCode函数**：
   - 使用React.useCallback包装generateAndFillCode函数
   - 添加调试日志，方便排查问题
   - 添加错误处理，生成失败时使用默认值

3. **修复表单重置问题**：
   - 使用setTimeout确保表单重置完成后再生成编号

4. **检查后端API**：
   - 确保后端的generate-code API能够正确返回产品编号
   - 确保返回的格式符合预期

5. **确保initialValues正确传递**：
   - 确保initialValues被正确传递到组件中
   - 确保initialValues中包含code字段

6. **验证修复结果**：
   - 运行前端开发服务器
   - 测试新增产品时是否自动生成产品编号
   - 测试编辑产品时是否显示当前产品的编号
   - 测试点击"重新生成"按钮是否可以重新生成产品编号

## 预期效果

- 新增产品时，自动生成产品编号并填充到输入框中
- 编辑产品时，显示当前产品的编号
- 点击"重新生成"按钮可以重新生成产品编号
- 支持手动编辑产品编号
- 产品编号生成规则：P+4位递增数字，超过9999后从10000继续递增

## 修复原理

- 正确的useEffect依赖确保了useEffect使用最新的函数引用
- React.useCallback确保了generateAndFillCode函数的稳定性
- 调试日志方便排查问题
- 错误处理确保了生成失败时的容错性
- setTimeout确保了表单重置和产品编号生成的正确顺序
- 正确的initialValues传递确保了编辑模式下的表单值正确

这个修复方案应该能够解决产品编号生成和表单值设置的问题，让产品管理功能恢复正常。